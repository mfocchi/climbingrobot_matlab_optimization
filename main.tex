\documentclass[letterpaper, 10 pt, conference]{IEEEtran}  % Comment this line out if you need a4paper

%\documentclass[a4paper, 10pt, conference]{ieeeconf}      % Use this line for a4 paper

\IEEEoverridecommandlockouts                              % This command is only needed if 
% you want to use the \thanks command

%\overrideIEEEmargins                                      % Needed to meet printer requirements.

\usepackage{amsmath, amssymb}
\usepackage{amsfonts}

\let\yesnumberold=\yesnumber\relax
\let\yesnumber\relax
\usepackage[math]{easyeqn}
\let\yesnumber\yesnumberold

\usepackage{bm}
\usepackage{multirow}
\usepackage{graphicx}
\setcounter{MaxMatrixCols}{30}
\usepackage{epstopdf}
\usepackage{enumerate}
\usepackage{color}

\usepackage{booktabs, tabularx}
\usepackage{multirow}

\usepackage{epstopdf}
\usepackage{epsfig}
\usepackage{subfigure}

\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{glossaries}

\include{include/acronyms}
\include{include/math_commands}

\usepackage{hyperref}

% Label definitions
\input{macros}

\title{\LARGE \bf Climbing robot}

\author{Marco Frego, MIchele Focchi, 
	Luigi Palopoli, .....
	%Alessandro Antonucci$^{1}$, Placido Falqueto$^{1}$,
	%	Luigi Palopoli$^{1}$, Daniele Fontanelli$^{2}$ %\vspace{0.1cm}
	%\IEEEoverridecommandlockouts
	% \IEEEpubid{\makebox[\columnwidth]
		% 	{\hfill : 978-1-5090-6299-7/17/\$31.00~\copyright~2017 European Union}
		%	\hspace{\columnsep}\makebox[\columnwidth]{ }}
	%\thanks{$^{1}$A. Antonucci,	P. Falqueto, and L. Palopoli
		%    are with the Department of Information Engineering and Computer Science (DISI), University of Trento, Via Sommarive 9, Trento, Italy (e-mail:
		%		\{alessandro.antonucci, placido.falqueto, luigi.palopoli\}@unitn.it) }%
	%\thanks{$^{2}$D. Fontanelli is with the Department
		%	of Industrial Engineering (DII), University of Trento, Via
		%	Sommarive 9, Trento, Italy (e-mail:
		%	daniele.fontanelli@unitn.it) }
}

\begin{document}
	
	\maketitle
	\thispagestyle{empty}
	\pagestyle{empty}
	
	
	
	\begin{abstract}
		
	\end{abstract}
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	
	\section{Model}
	The spherical pendulum model is shown in figure \ref{fig:sp} . where $\theta$ is the polar angle [rad] and $\phi$ is the Azimuth angle [rad] . \\ 
	\begin{figure}
		\includegraphics[width=\columnwidth]{figs/spherical_pendulum}
		\caption{Spherical pendulum}
		\label{fig:sp}
	\end{figure}
	We assume that:
	\begin{enumerate}
		\item The friction can be neglected
		\item The mass is entirely concentrated in the body attached to the wire
		\item The wire can be unwounded and rewounded but it is rigid and remains completely elongated (i.e., it cannot make bends)
		\item The rewinder can pull the wire when winding it but cannot push it (i.e., it can only act as a brake during the unwinding phase)
		\item The system is acted on by the following forces:
		\begin{itemize}
			\item The mass weight
			\item The rewinder pull action or braking action $\mathbf{F}_r$ oriented along the wire
			\item An impulsive push force $\mathbf{F}_u$ that the robot can generate when it is attached to the mountain wall
		\end{itemize}
	\end{enumerate}
	Let $e$ be a frame attached to the mass and with axis oriented along the $x$ axis and let $w$ be the world frame attached to
	the suspension point of the pendulum.
	If we consider the homogeneous transformation linking $e$ to $w$, we can write:
	\[
	T_e^w = \begin{bmatrix} R_z(\phi) &\begin{matrix}0\\0\\0 \end{matrix}  \\ \begin{matrix} 0 &0 &0 \end{matrix} & 1\end{bmatrix}  \begin{bmatrix} R_y(\pi/2 - \theta) &\begin{matrix}0\\0\\0 \end{matrix}  \\ \begin{matrix} 0 &0 &0 \end{matrix} & 1\end{bmatrix}  \begin{bmatrix} I_{3,3} &\begin{matrix}0\\0\\0 \end{matrix}  \\ \begin{matrix} L &0 &0 \end{matrix} & 1\end{bmatrix}  
	\]
	where $R_z(\phi)$ is the rotation matrix of $\phi$ around $z$ and $R_y(\alpha)$ is the rotation matrix of $\alpha$ around $y$.
	Overall, we have:
	\[
	T_e^w = \begin{bmatrix} c_\phi s_\theta & -s_\phi & c_\phi c_\theta & l c_\phi s_\theta\\
		s_\phi s_\theta & c_\phi & c_\theta s_\phi & l s_\phi s_\theta\\
		-c_\theta & 0 & s_\theta &-l c_\theta\\
		0 & 0 &0 &1\end{bmatrix}
	\]
	where $c_x$ is a shorthand for $\cos x$ and $s_x$ is a shorthand for $\sin x$.
	From this equation, we have that the position $\mathbf{p}$ of the mass is given by:
	\begin{align} \label{eq1}
		\mathbf{p} = \begin{bmatrix} x\\ y\\ z \end{bmatrix} =
		\begin{bmatrix} l s_\theta c_\phi\\
			l s_\theta s_\phi\\
			-l c_\theta \end{bmatrix}
	\end{align}
	From equation \ref{eq1}, the velocities along the axes are:  
	\begin{align*}
		\dot{x} &= 
		l c_\theta c_\phi \dot{\theta} - l s_\theta s_\phi \dot{\phi} + s_\theta c_\phi \dot{l} \\
		\dot{y} &= l c_\theta s_\phi \dot{\theta} + l s_\theta c_\phi \dot{\phi} + s_\theta s_\phi \dot{l} \\
		\dot{z} &= l s_\theta  \dot{\theta} - c_\theta \dot{l} 
	\end{align*}
Next, the velocity of the mass is :
	\begin{align*}
		v^2 &= \dot{x}^2 + \dot{y}^2 + \dot{z}^2 \\		
		&=  l^2 c_\theta^2 c_\phi^2 \dot{\theta}^2 + l^2 s_\theta^2 s_\phi^2 \dot{\phi}^2 + s_\theta^2 c_\phi^2 \dot{l}^2 - 2l^2 c_\theta s_\theta c_\phi s_\phi   \dot{\theta} \dot{\phi} - 2l s_\theta^2 s_\phi c_\phi \dot{l} \dot{\phi} \\
		& + 2l c_\theta s_\theta c_\phi^2  \dot{\theta} \dot{l} + l^2 c_\theta^2 s_\phi^2 \dot{\theta}^2 + l^2 s_\theta^2 c_\phi^2 \dot{\phi}^2 + s_\theta^2 s_\phi^2 \dot{l}^2 + 2l^2 c_\theta s_\theta s_\phi c_\phi \dot{\theta} \dot{\phi} \\
		&+ 2l s_\theta^2 c_\phi s_\phi \dot{l} \dot{\phi} + 2l c_\theta s_\theta s_\phi^2  \dot{\theta} \dot{l} + l^2 s_\theta^2  \dot{\theta}^2 + c_\theta^2 \dot{l}^2 - 2l s_\theta c_\theta   \dot{\theta} \dot{l} \\ \\
		&= l^2 c_\theta^2 \left(c_\phi^2 + s_\phi^2\right) \dot{\theta}^2 + l^2 s_\theta^2  \left( s_\phi^2 + c_\phi^2 \right) \dot{\phi}^2 + l^2 s_\theta^2  \dot{\theta}^2 + \dot{l}^2 s_\theta^2 \left(c_\phi^2 + s_\phi^2\right) \\
		&+ 2l c_\theta s_\theta \left(c_\phi^2 + s_\phi^2\right) \dot{\theta} \dot{l} + c_\theta^2 \dot{l}^2 - 2l s_\theta c_\theta \dot{\theta} \dot{l} \\  \\
		&=  l^2 \dot{\theta}^2 + l^2 s_\theta^2 \dot{\phi}^2 + \dot{l}^2\\
	\end{align*}
	
	Thus, the kinetic energy $T$ of the system :
	\begin{align*}
		T &=\frac{ m }{2} v^2 \\
		&= \frac{m}{2} \left(\dot{x}^2 + \dot{y}^2 + \dot{z}^2\right) \\
		&=  \frac{m}{2} l^2 \left(\dot{\theta}^2 + s_\theta^2 \dot{\phi}^2 \right) + \frac{m }{2} \dot{l}^2 \\
	\end{align*}
And the potential energy $V$ :
		\begin{align*}
		V &= mgz\\
		&= -mgl c_\theta
	\end{align*}
 The Lagrangian function is given by:
	\begin{equation}
		L = T - V = \frac{m}{2} l^2 \left(\dot{\theta}^2 + s_\theta^2 \dot{\phi}^2\right) + \frac{m}{2}\dot{l}^2 + mgl c_\theta
	\end{equation}
	The generalized coordinates are in this case given by $q_1 = \theta, q_2 = \phi,$ and $q_3 = l$ .
	If we apply the d'Alembert principle, the Lagrangian Equation can be written as:
	\[
	\frac{d}{dt}\frac{\partial L}{\partial \dot{q}_i} - \frac{\partial L}{\partial q_i} = Q_i^p ,
	\]
	where $Q_i^p$ is the generalized force $Q_i^p = (\mathbf{F}_r + \mathbf{F}_u) \cdot \frac{\partial \mathbf{p}}{\partial q_i}$.
	Observe that  $\mathbf{F}_r$ oriented along the rope and $\mathbf{F}_u$ does not have any component along the rope (otherwise
	it will forms bends):
	\begin{align*}
		\mathbf{F}_r  &= F_r \begin{bmatrix}
			c_\phi s_\theta\\
			s_\phi s_\theta\\
			-c_\theta
		\end{bmatrix}^T = F_r \mathbf{f}_r \\	
		\mathbf{F}_u &= F_{u,t}\begin{bmatrix}
			-s_\phi\\
			c_\phi\\
			0
		\end{bmatrix}^T + F_{u,n} \begin{bmatrix}
			c_\phi c_\theta \\
			s_\phi c_\theta\\
			s_\theta
		\end{bmatrix}^T &= F_{u,t} \mathbf{f}_{u,t} + F_{u,n} \mathbf{f}_{u,n}    \\ 	 
	\end{align*}  
	while
	\begin{align*}
		\frac{\partial \mathbf{p}}{\partial q_1} = \frac{\partial \mathbf{p}}{\partial \theta} &= \begin{bmatrix}
			l c_\phi c_\theta\\
			l s_\phi c_\theta\\
			l s_\theta
		\end{bmatrix}\\
		\frac{\partial \mathbf{p}}{\partial q_2} = \frac{\partial \mathbf{p}}{\partial \phi} &= \begin{bmatrix}
			- l s_\phi s_\theta\\
			l c_\phi s_\theta\\
			0
		\end{bmatrix}\\
		\frac{\partial \mathbf{p}}{\partial q_3} = \frac{\partial \mathbf{p}}{\partial l} &= \begin{bmatrix}
			c_\phi s_\theta\\
			s_\phi s_\theta\\
			-c_\theta
		\end{bmatrix}\\
	\end{align*}
	Hence,
	\begin{align*}
		Q_1^p &= \left(\mathbf{F}_r + \mathbf{F}_u\right)   \frac{\partial \mathbf{p}}{\partial q_1}\\
		&= F_r \mathbf{f}_r \cdot  \frac{\partial \mathbf{p}}{\partial \theta} + \\
		&+ F_{u,t} \mathbf{f}_{u,t} \cdot  \frac{\partial \mathbf{p}}{\partial \theta} + \\
		&+ F_{u,n} \mathbf{f}_{u,n} \cdot  \frac{\partial \mathbf{p}}{\partial \theta}  =  \\
		&= F_{u,n} \mathbf{f}_{u,n} \cdot  \frac{\partial \mathbf{p}}{\partial \theta} = \\
		&= F_{u,n} l ,
	\end{align*}
	\begin{align*}
		Q_2^p &= \left(\mathbf{F}_r + \mathbf{F}_u\right)   \frac{\partial \mathbf{p}}{\partial q_2}\\
		&= F_r \mathbf{f}_r \cdot  \frac{\partial \mathbf{p}}{\partial \phi} + \\
		&+ F_{u,t} \mathbf{f}_{u,t} \cdot  \frac{\partial \mathbf{p}}{\partial \phi} + \\
		&+ F_{u,n} \mathbf{f}_{u,n} \cdot  \frac{\partial \mathbf{p}}{\partial \phi}   = \\
		&= F_{u,t} \mathbf{f}_{u,t} \cdot  \frac{\partial \mathbf{p}}{\partial \phi} =\\
		&= F_{u,t} l s_\theta,
	\end{align*}
	\begin{align*}
		Q_3^p &= \left(\mathbf{F}_r + \mathbf{F}_u\right)   \frac{\partial \mathbf{p}}{\partial q_3}\\
		&= F_r \mathbf{f}_r \cdot  \frac{\partial \mathbf{p}}{\partial l} + \\
		&+ F_{u,t} \mathbf{f}_{u,t} \cdot  \frac{\partial \mathbf{p}}{\partial l} + \\
		&+ F_{u,n} \mathbf{f}_{u,n} \cdot  \frac{\partial \mathbf{p}}{\partial l}   = \\
		&= F_r \mathbf{f}_r \cdot  \frac{\partial \mathbf{p}}{\partial l} =\\
		&= F_{r} .
	\end{align*}
	
	
	
	The first Euler-Lagrange equation yields
	\begin{align*}
		&\frac{d}{dt}\left(\frac{\partial L}{\partial \dot{\theta}} \right) - \frac{\partial L}{\partial \theta} = Q_1^p    \\
		&\frac{d}{dt}\left(m l^2 \dot{\theta}\right) - (m l^2 s_\theta c_\theta \dot{\phi}^2 - m g l s_\theta) = F_{u,n} . l \\ 
		&  m l^2 \ddot{\theta} + 2 m l \dot{\theta} \dot{l} - m l^2 s_\theta c_\theta \dot{\phi}^2 + m g l s_\theta = F_{u,n} . l\\
		& \ddot{\theta} + \frac{2}{l} \dot{\theta} \dot{l} - c_\theta s_\theta \dot{\phi}^2 + \frac{g}{l}  s_\theta =  \frac{F_{u,n}  }{ml}    
	\end{align*}
	
	The second Euler-Lagrange equation yields
	\begin{align*}
		&\frac{d}{dt}\left(\frac{\partial L}{\partial \dot{\phi}} \right) - \frac{\partial L}{\partial \phi} = Q_2^p    \\
		&\frac{d}{dt}\left(m l^2 s_\theta^2 \dot{\phi}\right) - 0 = F_{u,t} . l . s_\theta\\
		& \ddot{\phi} ml^2 s^2_\theta + 2 m l \dot{l} s_\theta^2 \dot{\phi} + 2 m l^2 s_\theta c_\theta \dot{\theta} \dot{\phi}  = F_{u,t} . l . s_\theta\\
		&\ddot{\phi} + 2 \frac{c_\theta}{s_\theta} \dot{\theta} \dot{\phi} + \frac{2}{l} \dot{\phi} \dot{l} = \frac{F_{u,t}}{ml s_\theta}
	\end{align*}
	
	The third Euler-Lagrange equation is as follows:
	\begin{align*}
		&\frac{d}{dt}\left(\frac{\partial L}{\partial \dot{l}} \right) - \frac{\partial L}{\partial l} = Q_3^p    \\
		&\frac{d}{dt}\left(m\dot{l}\right) - (m l \dot{\theta}^2 + m l s^2_\theta \dot{\phi}^2 + m g c_\theta) = F_r \\
		&m \ddot{l} - m l \dot{\theta}^2 - m l s^2_\theta \dot{\phi}^2 - m g c_\theta = F_r \\
		&\ddot{l} - l \dot{\theta}^2 - l s^2_\theta \dot{\phi}^2 - g c_\theta = \frac{F_r}{m} 
	\end{align*}
	Overall, the nonlinear equations of the system are:
	\begin{align}
		&\ddot{\theta} + \frac{2}{l} \dot{\theta} \dot{l} - c_\theta s_\theta  \dot{\phi}^2 + \frac{g}{l}  s_\theta =  \frac{1}{ml}F_{u,n} \\
		&\ddot{\phi} + 2 \frac{c_\theta}{s_\theta} \dot{\theta} \dot{\phi} + \frac{2}{l} \dot{\phi} \dot{l} = \frac{1}{ml s_\theta} F_{u,t} \\
		&\ddot{l} - l \dot{\theta}^2 - l s^2_\theta \dot{\phi}^2 - g c_\theta = \frac{1}{m} F_r 
	\end{align}
	
	
	
	
	
	\section{System in canonical form}
	The system derived from the physical model is
	%%%
%	\begin{EQ}[rcl]
%		l\ddot{\theta}+2\dot{\theta}\dot{l}-l\dot{\phi}^2\sin\theta\cos\theta+g\sin\theta &=& \frac{F_{u,n}}{m},\\
%		\ddot{\phi}l\sin^2\theta+2\dot{\phi}\left(\dot{l}\sin^2\theta+l\dot{\theta}\sin\theta\cos\theta\right)&=& \frac{F_{u,t}\sin\theta}{m},\\
%		\ddot{l}-l\left(\dot{\theta}^2+\dot{\phi}^2\sin^2\theta\right)-g\cos\theta&=&\frac{F_{r}}{m}.
%	\end{EQ}
	
	%%%%
	%\begin{EQ}[rcl]
	%\ddot{\theta}(t)+2\dot{\theta}(t)\dot{l}(t)-l(t)\sin\theta(t)\cos\theta(t)\dot{\phi}^2(t)+g\sin\theta(t) &=& \frac{F_{u,n}(t)}{m},\\
	%\ddot{\phi}(t)l(t)\sin^2\theta(t)+2\dot{\phi}(t)\left(\dot{l}(t)\sin^2\theta(t)+l(t)\sin\theta(t)\cos\theta(t)\dot{\theta}(t)\right)&=& \frac{F_{u,t}(t)\sin\theta(t)}{m},\\
	%\ddot{l}(t)+l(t)\left(\dot{\theta}^2(t)+\sin^2\theta(t)\dot{\phi}^2(t)\right)+g\cos\theta(t)&=&\frac{F_{r}(t)}{m}.
	%\end{EQ}
	
	
	Recast as a first order system with the substitutions
	%%%
	\begin{EQ}
		\dot{\theta} = \omega,\quad \dot{\phi}=\psi,\quad \dot{l}=r.
	\end{EQ}
	%%%
	Reorder the system in canonical form $\dot{\bm{x}}(t)=f(\bm{x}(t),\bm{u}(t))$, where x is the state and u is the control input. 
	For the spherical pendulum system, the state is defined as : 
	
	\begin{align}
          \label{eq:State}
		x^T= [\theta \quad   \phi \quad   l \quad \dot{\theta} \quad   \dot{\phi}\quad   \dot{l}] \\
		u^T = \mat{ F_{u,t} & F_{u,n} &  F_{r}}
	\end{align}
	
	
	\begin{align} % TODO check Fun cause is an inpulse not a force
	\label{eq:optim_ctrl_problem}
		\argmin_u &= w_T T_f + w_{K}K_f \\
		&\st
		& \dot{x} = f(x,u,t; T_f) 
		& \quad l s_\theta c_\phi > 0 \\
		        &-F_{r,max} \leq F_r \leq 0 \\ %rope can only pull
			    & 0 \leq F_{u,n}  \\ %unilateral
			    &  F_{u,t}^2 + F_{u,n}^2 \leq F_{u,max}^2 \\ % actuation 
			    &  \vert F_{u,t} \vert   \leq \mu_f  F_{u,n} \\ % friction		
			    & p(0) = p_0 \\ % initial pos
			    & \omega_{0} = 0 \quad  \psi_{0} = 0  \quad r = 0 \\
			    & p(T_f) = p_f % final pos	      			     
	\end{align}
	
	
	where $K_f$ is K computed at $t = T_f$: %TODO rename T in K
	\begin{align}
	 K_f =& \frac{m}{2} l(T_f)^2 \left[ \omega(T_f)^2 + s_\theta(T_f)^2 \right. \\ 
			 & \left. +\psi(T_f)^2\right] + \frac{m}{2}r(T_f)^2 + mgl(T_f) c_\theta (T_f)
 	\end{align}
	
	and $ f(x,u,t) $ is equal to:
	
	
	%%
	\begin{equation}
    \begin{aligned}
		\dot{\theta} =& \omega,\\
		\dot{\phi}   =&\psi,\\
		\dot{l}      =&r,\\
	    \dot{\omega} =& - \frac{2}{l}\omega r +  \psi^2 c_{\theta} s_{\theta} -\frac{g}{l} s_{\theta} + \frac{1}{ml} F_{u,n} f(t)\\
	    \dot{\psi} =&  -2 \frac{c_{\theta}}{s_{\theta}} \omega \psi - \frac{2}{l}\psi r + \frac{1}{ml s_{\theta} } F_{u,t} f(t)\\
	    \dot{r} =& l \omega^2 + ls_{\theta}^2 \psi^2 + g c_{\theta} + \frac{1}{m} F_r
        \end{aligned}
        \label{eq:CanonicalForm}
	\end{equation}
	%%%
	where: 
	
	\begin{align*}
	\centering
	&\mu = T_{th}/2\\
	&3 \sigma = T_{th}/2\\
	&f(t) = \frac{1}{\sqrt{ 2  \pi \sigma^2}} e^{\left( \frac{-(t - \mu)^2}{2\sigma^2} \right)}
	\end{align*}
	
	input parameters are: 
	
	$T_{th}= 0.05$, 	$\mu_f = 0.8$,	$F_{u,max}  =150 N$,	$F_{r,max} =80 N$; % Fr in negative

	
	
	The boundary conditions for a movement starting and ending at rest ($v=0$) are
	%%%
	\begin{EQ}[rclcl]
		x &=& l\sin\theta\cos\phi &=& x_0\\
		y &=& l\sin\theta\sin\phi &=& y_0\\
		z &=& -l\cos\theta        &=& z_0\\
		x &=& l\sin\theta\cos\phi &=& x_T\\
		y &=& l\sin\theta\sin\phi &=& y_T\\
		z &=& -l\cos\theta        &=& z_T\\
	\end{EQ}
	%%%
	from which,
	%%%
	\begin{EQ}
		l = \sqrt{x_0^2+y_0^2+z_0^2}, \quad \theta= \atandue\left(-z_0,\sqrt{x_0^2+y_0^2}\right), \quad \phi = \atandue(y_0,x_0).
	\end{EQ}
	
	For the velocity, at $t=0$:
	
	\begin{EQ}[rclcl]
		\dot{x} &=& \cos(\theta)\cos(\phi)l\omega-\sin(\phi)\sin(\theta)l\psi+\sin(\theta)\cos(\phi)r &=& 0\\
		\dot{y} &=& \cos(\theta)\sin(\phi)l\omega+\cos(\phi)\sin(\theta)l\psi+\sin(\theta)\sin(\phi)r &=& 0\\
		\dot{z} &=& \sin(\theta)l\omega -\cos(\theta)r &=& 0
	\end{EQ}
	
	At $t=T$:
	\begin{EQ}[rclcl]
		\dot{x} &=& \cos(\theta)\cos(\phi)l\omega-\sin(\phi)\sin(\theta)l\psi+\sin(\theta)\cos(\phi)r &=& 0\\
	    \dot{y} &=& \cos(\theta)\sin(\phi)l\omega+\cos(\phi)\sin(\theta)l\psi+\sin(\theta)\sin(\phi)r &=& 0\\
	    \dot{z} &=& \sin(\theta)l\omega -\cos(\theta)r &=& 0
	\end{EQ}
	
	Sufficient conditions to have zero velocity at $t=0$ and at $t=T$ are
	%%%
	\begin{EQ}
		\dot{l}=r=0, \qquad \dot{\theta}=\omega=0, \quad \dot{\phi}=\psi = 0.
	\end{EQ}
	%%%
	
	%\bibliographystyle{IEEEtran}
	%\bibliography{biblio}


\section{Input parametrization}

The control input should be a smooth and differentiable function of time. To fulfill these requirements we propose two solutions: 1) a curve that has the shape of a Gaussian 2) built with Bezier curves, 3) built with piece-wise quintic polynomials. We assume the jump duration is $T_f=2s$ and the mass of the robot $m=5 kg$ and the duration of the thrusting phase as $T_{th} = 0.05 s$. For plotting purposes the max force is set to $ 3mg $ but it will be a free variable in the optimization. In the case of Gaussian we get (see Fig. \ref{fig:gaussian}):

\begin{figure}
	\includegraphics[width=\columnwidth]{figs/gaussian}
	\caption{Gaussian, plot limited to $T_{th}+0.1$}
	\label{fig:gaussian}
\end{figure}


\begin{align*}
\centering
&\mu = T_{th}/2\\
&3 \sigma = T_{th}/2\\
&f(t) = e^{\left( \frac{-(t - \mu)^2}{2\sigma^2} \right)}
\end{align*}

In the case of the Bezier curve we chose the Bezier curves that are binomial polynomial with this expression:

\begin{align*}
\centering
B(n, t) = \sum_{i=0}^n \binom{n}{k} (1-t)^{n-i} t^i w_i  
\end{align*}

where $n$ is the order the Bezier curve. 
We select two 3rd order curves (with 4 control points each)  for the increasing / decreasing  parts of the thrust phase.  
We can select the control points to be $[0, 0, 1,1]$ to have flatness at the beginning and at the end and ensure differentiability for the whole curve. 
To improve the tuning the shape of the Bezier curves it is convenient to use rational Beziers:

\begin{align*}
\centering
B_r(n, t) = \frac{ \sum_{i=0}^n \binom{n}{k} (1-t)^{n-i} t^i w_i r_i  } {  \sum_{i=0}^n \binom{n}{k} (1-t)^{n-i} t^i r_i }
\end{align*}

where se set the relative influence $r$ of the control points as $r= [1,0.5, 0.5, 1]$.
The resulting curve is plot in Fig. \ref{fig:bezier}):
\begin{figure}
	\includegraphics[width=\columnwidth]{figs/bezier}
	\caption{Bezier, plot limited to $T_{th}+0.1$}
	\label{fig:bezier}
\end{figure}

In the case of a quintic polynomial parametrization we split the impulse curve into two polynomials  both with 0 first and second derivative at start and end. The first one is going from 0 to $f_{max}$, the second from $f_{max}$ to 0. They have the form:
%
\begin{align*}
f(t) &= a_0  + a_1 t +  a_2 t^2 + a_3 t^3 + a_4 t^4 + a_5 t^5\\
\end{align*} 

we obtain the coefficient solving a system of linear equations obtained by imposing the boundary conditions, which can be rewritten in matrix form as: 
\begin{equation*}
\begin{bmatrix}
f_0 \\
0 \\
0 \\
f_f \\
0 \\
0
\end{bmatrix} =
\begin{bmatrix}
1 & 0   & 0     &       0 &        0 &     0 \\
0 &   1 &     0 &       0 &        0 &     0 \\
0 &   0 &     2 &       0 &        0 &     0 \\
1 & t_f & t_f^2 &   t_f^3 &    t_f^4 & t_f^5 \\
0 &   1 & 2 t_f & 3 t_f^2 &  4 t_f^3 & 5 t_f^4 \\
0 &   0 &     2 &   6 t_f & 12 t_f^2 & 20 t_f^3
\end{bmatrix}
\begin{bmatrix}
a_0 \\
a_1 \\ 
a_2 \\
a_3 \\
a_4 \\
a_5
\end{bmatrix}
\end{equation*}
the differentiability at $t = T_{th}$is ensured   because we set the second derivative to be zero. A plot of the curve is in Fig. \ref{fig:polynomial}:

\begin{figure}
	\includegraphics[width=\columnwidth]{figs/polynomial}
	\caption{Polynomial curve, plot limited to $T_{th}+0.1$}
	\label{fig:polynomial}
\end{figure}

\section{Actuation and Friction cone constraints}
We assume at the beginning the robot is attached to the wall so $\theta \approx 0$, hence the thrusting force has no component along the radial direction. 
The robot has a maximum actuation effort that can deliver, we model this with an upper bound on the norm $F_{u,n}$ of the force:

\begin{align*}
\sqrt{ F_{u,n}^2 + F_{u,t}^2} \leq F_{max}  
\end{align*} 

where we set  $F_{max} = 200 N$ in  our optimization. Both, $F_{u,n}$ and $F_{u,t}$ will have the shape in Fig. \ref{fig:gaussian}. Additionally, the nature of the contact imposes some (friction) constraint on the tangential component w.r.t. the normal one, to maintain the grip:

\begin{align*}
F_{u,t}\leq \mu F_{u,n}
\end{align*} 

where $\mu = 0.8$ is the friction coefficient. We consider this constraint only on the $t$ component because we assumed the force vector $F_u$ lies in the plane $t-n$ without component in the radial component along $r$.
Finally, because the robot cannot pull himself towards the wall but only push:

\begin{align*}
F_{u,n}\geq  0
\end{align*} 



\section{Energy Based Planning}
\input{include/energy}



\section{Multiple Jumps Heuristics}

The usage of the iso-energetic curves allows us to parametrize the curves as polynomials with constraints on derivative of energy, 
without having to solve an optimal control problem.
In case of multiple jumps (e.g. 3), the optimization should come up with a set of fixed-rope length jumps $\mat{\theta_1, \theta_2, \theta_3} $ 
and vertical releases $\mat{l_{p,1},l_{p,2},l_{p,3}}$  we have to enforce also the following kinematic constraints, to reach the target:  


\begin{align*}
...
\end{align*} 

and to map $\mat{l_{p,1},l_{p,2},l_{p,3}}$ into rope lengths (for simulation purposes):

\begin{align*}
...
\end{align*} 

\begin{figure}
	\includegraphics[width=\columnwidth]{figs/multiple_jumps_heuristics.pdf}
	\caption{Heuristics for multiple jumps}
	\label{fig:muti_jumps}
\end{figure}

\section{Slider model}
In Fig. \ref{fig:sliderModel} we present the model of the robot where the anchor point is movable by means of a slider. 

\begin{figure}
	\includegraphics[width=\columnwidth]{figs/simplifiedModelSlider.pdf}
	\caption{Spherical pendulum with slider}
	\label{fig:sliderModel}
\end{figure}

Adding a slider introduces a prismatic joint whose axis is aligned with the y axis, we pre-pend to the state vector 
the linear position $s_y$ of the slider and compute the position of the mass  is given by:

\begin{align} \label{eq1slider}
\mathbf{p} = \mat{ x\\ y\\ z} =
			\mat{ l s_\theta c_\phi\\
				  s_y + l s_\theta s_\phi\\
					-l c_\theta}
\end{align}


From equation \ref{eq1slider}, the velocities along the axes are:  

\begin{align*}
\dot{p} &=  \mat{ \dot{x}\\ \dot{y}\\ \dot{z}} =
\mat{   l c_\theta c_\phi \dot{\theta} - l s_\theta s_\phi \dot{\phi} + s_\theta c_\phi \dot{l} \\
		\dot{s_y} + l c_\theta s_\phi \dot{\theta} + l s_\theta c_\phi \dot{\phi} + s_\theta s_\phi \dot{l} \\
		l s_\theta  \dot{\theta} - c_\theta \dot{l} }
\end{align*}

The kinetic energy of the whole system is: 

\begin{align}
T = T_s + T_m = \frac{1}{2}m_s v_s^2  + \frac{1}{2}m v^2 
\label{eq:ekinSlider}
\end{align}

where
\begin{align}
v_s^2& = \mat{0 & \dot{s}_y & 0}\mat{0 & \dot{s}_y & 0}^T = \dot{s}_y^2  \nonumber \\
v^2 &=   \dot{l}^2 + \dot{s}_y^2 + l^2s_\theta^2\dot{\phi}^2 + l^2\dot{\theta}^2 +  \nonumber\\
& \textcolor{blue}{
			 2  \dot{l}\dot{s}_y s_\phi  s_\theta 
			+ 2 l \dot{\phi} \dot{s}_y c_\phi s_\theta  +  2l\dot{s}_y \dot{\theta}c_{\theta} s_\phi}
\end{align}


From which the Lagrangian takes this form:
\begin{align}
L& =\textcolor{blue}{ \frac{1}{2} m_s\dot{s}_y^2} +  
\frac{1}{2}m \left[ \dot{l}^2 + l^2\dot{\phi} s_{\theta}^2 + l^2 \dot{\theta}^2\right] +   \nonumber \\
& \textcolor{blue}{ \frac{1}{2}m \left[\dot{s}_y^2 + 2\dot{l}^2  \dot{s}_y s_\phi s_\theta + 
	2l\dot{\phi} \dot{s}_y c_\phi s_\theta +
	2l\dot{s}_y \dot{\theta} c_\theta s_\phi \right]}  + glm c_{\theta}
\label{eq:lagrSlider}
\end{align}

where all the additional terms with respect to the non slider case (in blue) appear to be dependent on $\dot{s}_y$, as expected. 
We added a force $F_s$ applied along the slider direction ($Y$) to the point mass of the movable anchor $m_s = 2$ kg. We set for $F_s$ the bounds of $\pm 200 $ $N$.
The initial value for the slider position is $s_y = 0 m$. The final value of the slider position to be able 
From the Euler Lagrange equations we get the differential equations that describe the dynamics:

The first equation, relative to the $s_y$ degree of freedom is:

\begin{align}
& ( m +m_s) \ddot{s}_y  + 2lmc_\phi c_\theta \dot{\phi} \dot{\theta} + \nonumber \\
&2\dot{l}m c_\phi s_\theta \dot{\phi}   + s_\phi s_\theta ( \ddot{l}m - l m \dot{\theta}^2  -lm \dot{\phi}^2 )  + \nonumber \\ 
& lm\ddot{\phi} c_\phi s_\theta + c_\theta s_\phi (lm \ddot{\theta} +2\dot{l} m  \dot{\theta}) = F_s + F_{ut} c_\phi + F_{un}c_\theta s_\phi + F_r s_\phi s_\theta
\label{eq:slider1}
\end{align}


The second equation, relative to the $\theta$ degree of freedom is:


\begin{align}
\ddot{\theta} + \frac{2}{l}\dot{\theta}\dot{l}  -c_\theta s_\theta \dot{\phi}^2 +  \frac{g}{l}s_\theta 
+ \textcolor{blue}{\frac{1}{l}\ddot{s}_y c_\theta s_\phi} = \frac{F_{un}}{ml}
\label{eq:slider2}
\end{align}


The third equation, relative to the $\phi$ degree of freedom is:

%
\begin{equation}
 \ddot{\phi} +  2\dot{\phi}\dot{\theta} \frac{c_\theta}{s_\theta}  + \frac{2}{l} \dot{\phi} \dot{l}  +  \textcolor{blue}{\frac{1}{l s_\theta}  c_\phi \ddot{s}_y} =  \frac{ F_{ut}}{mls_\theta}
 \label{eq:slider3}
\end{equation}

The fourth equation, relative to the $l$ degree of freedom is:


\begin{equation}
\ddot{l}  - l\dot{\theta}^2 - l\dot{\phi}^2 s_\theta^2  - gc_\theta   + \textcolor{blue}{\ddot{s}_y s_\phi s_\theta} = \frac{F_r}{m}
\label{eq:slider4}
\end{equation}

where the additional terms due to the slider are depicted in blue. These equations are coupled and to properly derive the accelerations we need to put them in matrix form:

\begin{equation}
\mat{a_{11} & a_{12} & a_{13} & a_{14} \\
	 a_{21} & a_{22} & a_{23} & a_{24} \\
	 a_{31} & a_{32} & a_{33} & a_{34} \\
	 a_{41} & a_{42} & a_{43} & a_{44} }\mat{\ddot{s}_y \\ \ddot{\theta} \\ \ddot{\phi} \\ \ddot{l} } = \mat{b_1\\b_2\\b_3\\b_4}
\end{equation}

where $a_ij$, $b_i$ can be extracted from \eqref{eq:slider1}, \eqref{eq:slider2}, \eqref{eq:slider3},\eqref{eq:slider4}.
The initial values and final values for the joints are related to the Cartesian position $p$ of the mass as follows:

\begin{align}
 l &= \sqrt{p_x^2+ (p_y-s_y)^2+p_z^2}\\
 \phi& = atan2(p_y - s_y, p_x);\\
 \theta& = acos(-p_z/l);
\end{align}

Note that, differently from the case without slider, this robot is redundant, hence there are infinite joint configurations that correspond to the  same Cartesian position.
Therefore we can select the slider position to have the sliding anchor on top of the resting positions. This is a convenient choice, because from the next static analysis, it will be apparent
that static stability can be kept only on the neighborhood of the vertical with the supporting anchor.  


\section{Two anchor model}

To derive the model with two anchor points, we employ a Newtonian approach 
modeling the system as a point mass under the action of the (unilateral) forces coming from the ropes and the leg. 
Exploiting the fact that we have a kinematic loop (i.e. between the two anchor points) 
we adopt a redundant representation of the system configuration choosing as degrees of freedom the Cartesian position $\vec{p}\in\Rnum^3$ of the mass 
and the lengths $l_1 \in \Rnum$, $l_2\in \Rnum$ of the two ropes:

\begin{equation}
\vec{q} = \mat{\vec{p}^T &l_1 &l_2}^T \in \Rnum^5
\end{equation}

the Newton Equation becomes:
\begin{equation}
m \ddot{p} -mg = (\vec{p} - \vec{p}_{a,1}) f_{r,1} +(\vec{p} - \vec{p}_{a,2}) f_{r,2} + \vec{F}_{leg}
\end{equation}



where $\vec{p}_{a,1}$, $\vec{p}_{a,2}$, are the two anchor point positions, respectively, while $f_{r,1}$, $f_{r,2} 
\in \Rnum$ are the magnitudes of the forces exerted by the ropes and $F_{leg} \in \Rnum^3$ is the impulsive force generated by the leg. 
By enforcing the following two scalar constraints, the total number of degrees of freedom becomes 3:

\begin{figure}
	\includegraphics[width=\columnwidth]{figs/simplifiedModel2anchors.pdf}
	\caption{Simplified model with two anchor points.}
	\label{fig:2anchorsModel}
\end{figure}

\begin{align}
&(\vec{p} - \vec{p}_{a,1})^T(\vec{p} - \vec{p}_{a,1}) = l_1\\
&(\vec{p} - \vec{p}_{a,2})^T(\vec{p} - \vec{p}_{a,2}) = l_2 \nonumber
\end{align}

 
for the Euler integration it is convenient to express these constraints at the acceleration level:

\begin{align}
(\vec{p} - \vec{p}_{a,1})^T \ddot{p} + \dot{p}^2 = \dot{l_1}^2 + l_1\ddot{l_1}\\
(\vec{p} - \vec{p}_{a,2})^T \ddot{p} + \dot{p}^2 = \dot{l_2}^2 + l_2\ddot{l_2}\nonumber
\end{align}
 

Then, we can isolate the accelerations to get the differential equations of the dynamics, in the following matrix form:

\begin{align}
&\underbrace{\mat{ m I_{3 \times 3}              & 0   & 0\\
	(\vec{p} - \vec{p}_{a,1})^T     & -l_1  & 0 \\
	(\vec{p} - \vec{p}_{a,2})^T     & 0  & -l_2}}_A \mat{\ddot{p} \\ \ddot{l}_1 \\\ddot{l}_2} = \\
&\quad \quad\underbrace{ \mat{ mg + (   \frac{ \vec{p} - \vec{p}_{a,1}}{ \Vert \vec{p} - \vec{p}_{a,1}\Vert}  f_{r,1} +\frac{ \vec{p} - \vec{p}_{a,2}}{ \Vert \vec{p} - \vec{p}_{a,2} \Vert} f_{r,2} + \vec{F}_{leg}\\
				 \dot{l}_1^2 -\dot{p}^2 \\
				 \dot{l}_2^2 -\dot{p}^2}}_b				 
\end{align}

from which we get: 

\begin{align}
 \mat{\ddot{p} \\ \ddot{l}_1 \\\ddot{l}_2} =  A^{-1}b		 
\end{align}

Since the matrix A is lower triangular, it is possible to compute directly a symbolic expression for the vector $A^{-1}b$:

\begin{align}
\mat{ 		\frac{b_1}{m}\\
	\frac{b_2}{m}\\
	\frac{b_3}{m}\\
	\frac{r_{11} b_1}{m l_1} + \frac{r_{12} b_2}{m l_1} + \frac{r_{13} b_3}{m l_1} - \frac{b_4}{ l_1}  \\
	\frac{r_{21} b_1}{m l_2} + \frac{r_{22} b_2}{m l_2} + \frac{r_{23} b_3}{m l_2} - \frac{b_5}{ l_1}  }
\end{align}


the initial state $\vec{q}_0, \vec{\dot{q}}_0 \in \Rnum^5$ usable for the integration, 
can be computed from the initial position of the mass $\vec{p}_0$ and of the initial velocity of the rope 
extensions $\dot{l}_1$, $\dot{l}_2$:

\begin{align}
\vec{\dot{q}}_0 &= \mat{  J_0 \mat{\dot{l}_1 \\ \dot{l}_2} & \dot{l}_1     &  \dot{l}_2   }^T\\
 \vec{q}_0 &= \mat{ \vec{p}_0 & \Vert \vec{p}_0 - \vec{p}_{a,1} \Vert &  \Vert \vec{p}_0 - \vec{p}_{a,2} \Vert}^T
\end{align}

where $J_0 = \mat{\frac{ \vec{p} - \vec{p}_{a,1}}{ \Vert \vec{p} - \vec{p}_{a,1}\Vert}   & \frac{ \vec{p} - \vec{p}_{a,2}}{ \Vert \vec{p} - \vec{p}_{a,2}\Vert}  } \in \Rnum^{3 \times 2} $ is the Jacobian that maps $\dot{l}_1$, $\dot{l}_2$
into feasible robot positions (i.e. in the range space of $J_0$).

\subsection{Full robot description}

Similarly to what has been done in our previous work \cite{icra23climb},
we report  also a full detailed model  of the robot  (see Fig. \ref{fig:3dmodel2anchors}(left)) in 
the cases of two ropes (in the slider case the model is the same as in \cite{icra23climb}
with an additional actuated prismatic joint and link attached to the anchor moving along the $Y$ direction). 
In the two rope case we model the robot as three kinematic chains branching from the base link. 
One is represented by the propulsion mechanism (a 3-DoFs
robotic leg) which is invariant w.r.t \cite{icra23climb}. At the extreme of the leg there is a point-like 
foot that enables to exert a \textit{pure} Cartesian force (no moment) on the wall. 
The leg has two \textit{subsequent} rotational joints, called  hip pitch ($q_{HP}$ about the Y axis (green)) and hip 
roll ($q_{HR}$ about the X axis (red)) that are used to  to align the leg to the thrusting impulse. 
This enables to avoid \textit{centroidal} moments that
would pivot the robot around the rope axis.
A prismatic knee ($q_{K}$) joint is used to generate the \textit{thrusting} impulse.
The robot will is not able to stabilize itself on the wall, therefore two additional passive rotational 
joints ($q_{L,l}$, $q_{L,r}$), that represent the \textit{landing} mechanism, are added at the sides of the base. 
To not overload the picture these joints are depicted in  Fig. \ref{fig:3dmodel2anchors}(right)).
Finally we have other two kinematic chains represented by the two ropes and their attachments. Note that the attachment points of the ropes are not coincident with 
the base frame origin  as in the simplified model, 
but have an offset $\delta$. This has  two-fold reasons: 1)  leave enough space to locate the hoist, 2) have a self-stabilizing effect on the base orientation under the gravity action.
We model the attachment between each anchor  and  rope with 2 \textit{passive} (rotational) joints.
The ropes are modeled as an \textit{actuated} prismatic joint ($q_{R,l},q_{R,r}$), 
followed by 3 \textit{passive} rotational joints to model 
the connection between the rope and the \textit{base link} of the robot
\footnote{It would be equivalent to allocate 3 joints at the anchor point and 2 at the base. 
To avoid redundancy in the representation, it is necessary  to have only one passive joint along the rope axis.}. 
Without considering the leg joints, the robot is equivalent to a double spherical pendulum with the second link of zero length.

\begin{figure}[t]
	\centering
	\includegraphics[width=0.45\columnwidth]{figs/3dmodel2anchors.pdf}
		\includegraphics[width=0.45\columnwidth]{figs/landing.pdf}
   	\caption{(left) Kinematic model of the ALPINE robot with two ropes (standard definitions). 
		The anchor frame is aligned with an inertial ($\mathcal{W}$) frame. (right) Overview of the landing mechanism, with base frame definition.}
	\label{fig:3dmodel2anchors}
\end{figure}

The total number of \gls{dofs} is   $n=15$  represented by the configuration vector $\vect{q} \in \Rnum^n$.  Where 10 of them, relative to the attachments of the rope systems, are underactuated. 
The dynamics equation will be subject to a holonomic  constraint represented by the fact that the two attachment points 
are located at a fixed distance $\delta$. 

\begin{align}
&\Vert {}_w\vec{p}_{r,1}(q)  - {}_w\vec{p}_{r,2}(q) \Vert = \delta^2
\end{align}

This creates  a  kinematic loop formed by the triangle with the two ropes as edges.
It is convenient to express this  constraint at the velocity level, hence we differentiate it w.r.t time we obtain: 
\begin{align}
&2({}_w\vec{p}_{r,1}(q)  - {}_w\vec{p}_{r,2}(q))(({}_w\vec{\dot{p}}_{r,1}(q)  - {}_w\vec{\dot{p}}_{r,2}(q))) = 0
\label{eq:constraint}
\end{align}

Making explicit the joint velocity dependency through the Jacobian we can rewrite \ref{eq:constraint} in Pfaffian form:

\begin{align}
\underbrace{({}_wJ_{r,1}(q)  - J_{r,2}(q))}_A(q)\dot{q} = 0
\label{eq:constraint1}
\end{align}

where ${}_wJ_{r,1}$ and ${}_wJ_{r,2}$ are the Jacobians of the two rope attachment points, respectively. 
Note that this constraints does not affect the position but only the attitude of the robot.
Then the  equation of motion will be written as:
\begin{align}
&\vect{M} (\vect{q}) \vect{\ddot{q}} + \vect{h}(\vect{q},\vect{\dot{q}}) = \mat{\vect{0}_{10 \times 1} \\ \boldsymbol{\tau}_a} + \vect{J}^T \vect{F}_c \\
&A(q)\dot{q} = 0
\end{align}

where $\vect{M} \in \Rnum^{n \times n}$ is the inertia matrix; $\vect{h} \in \Rnum^n$ represents the bias terms (Centrifugal, Coriolis and Gravity); and 
$\vect{J} \in \Rnum^{3 \times n} $ is the Jacobian relative to the contact point mapping the contact force $\vect{F}_c \in \Rnum^3$. 
Unless specified, all  vectors are expressed in an inertial $\mathcal{W}$ frame (attached to the anchor). 
The under-actuation is captured by the vector $\vect{0}_{10 \times 1}$, while 
the efforts of the actuated joints are grouped into the vector 
$\boldsymbol{\tau}_a = \mat{ \boldsymbol{\tau}_{R,l} & \boldsymbol{\tau}_{R,r}  & \boldsymbol{\tau}_{\text{leg}}}^T \in \Rnum^5$.

We implement the simulation of the dynamics in a Gazebo environment using URDF to describe the robot kinematics and Pinocchio library to compute the kinematics functions. 
The URDF format itself does not support closed kinematic chains (i.e. two joints cannot have the same child link), however this is possibile to do in SDF (Simulation Description Format) format 
which is the one used by Gazebo. So we embed a fixed joint at the SDF level to close the loop between the kinematic branch coming from the second anchor and the base link.
Particular care should be paid to initialize the system in a way that at startup, the joint configuration fulfills this kinematic constraint, otherwise the Gazebo's ODE physic engine solver would fail to converge and is be able to enforce the constraint along the whole duration of the simulation. 



\section{Static Analysis}

In this section we perform a static analysis to evaluate the static stability of the robot in the case of two ropes
for a set of positions of the robot on the wall. This analysis is important because it allows us to evaluate the margin of stability and
hence the amount of forces that can be tolerated by the robot during maintenace operations without loosing the contact.

It is rather intuitive to think that the possible operating force is strictly linked to the gravity component due to the weight of the robot and that it drops to zero 
when the rope axis becomes vertical to the wall. Being this an extreme case of no use, we will consider in this analysis a situation in which we have a certain angle $\theta$
between the  rope and the wall (see Fig. \ref{sec:static}). 
Regarding lateral forces it is  intuitive that having two ropes allows to increase the range of forces that can 
be tolerated as disturbances during maintenance operations or to balance a payload. 
Thanks to the fact that the tension of the ropes can be regulated at will, it is evident that the reultant of the 
rope forces will live on a manifold (i.e. a convex cone) whose generators are the rope axes. 
To perform this analysis we consider the simplifed model of the robot where the landing system is composed by two massless legs with 
two feet in contact. A static equilibrium involves the balance of forces and moments (e.g. about the \gls{com} point).  
The contact forces for the landing feet are linear forces (we do a point-feet assumption) and are limited by the  constraints posed by the nature the the contact, 
this means they should obey unilateral and friction constraints. 


\noindent \textit{Problem statement}:  for a specific Cartesian position 
of the robot against the wall we want to find if it exist a feasible combination of 
forces (at the landing feet $f_{L,l}, f_{L,r} \in \Rnum^3$  and at the ropes  $f_{R,l}, f_{R,r} \in \Rnum$) that satisfy the static equilibrium condition. 
Because we have 3+3+1+1=8 unknowns and 6 equations  ( balance of forces and moments) the problem is undetermined and we have infinite solutions. 
We chose to solve the indeterminacy by getting the \textit{minimum norm} solution  casting the problem  as a QP program 
where we regularize  $\Vert x\vert$ to get a unique solution: \footnote{For simplicity we neglect any compliance in the structure and in the landing mechanism and consider the robot as a single rigid body.}

\begin{align}
\argmin x^T W x \\
s.t. A x = b \\
C x \leq d
\label{eq:constraint1}
\end{align}	

where $x$ is the set of decision variables that ensembles all the external forces acting on the systems:

\begin{align}
x = \mat{f_{L,l} & f_{L,r}&  f_{R,l}& f_{R,r}}
\label{eq:constraint1}
\end{align}	
	
and $W$ is a wighting matrix defined as:  

\begin{align}
W = \mat{ w_f I_{3x3} & 0_{3x3} & 0  & 0 \\
	          0_{3x3} & w_f I_{3x3} & 0  & 0 \\
	          0_{1x3} & 0_{1x3}  &w_r  & 0 \\
   	          0_{1x3} & 0_{1x3} & 0  & w_r }
\label{eq:constraint1}
\end{align}	

while the balance equations (linear forces and moments) can be rephrased in matrix form coming up with the  $A$, $b$ quantities:
	
\begin{align}
A =\mat{I_{3 \times 3} & I_{3 \times 3} & {}_w\hat{p}_{R,l} & {}_w\hat{p}_{R,r}\\
		\left[ {}_wp_{f,l} \right]_{\times} & 	\left[ {}_wp_{f,l} \right]_{\times} & 0_{3x1} & 0_{3x1} } \quad b = \mat{ -m\vec{g} \\ 0_{3x1}}
\label{eq:constraint1}
\end{align}	

where ${}_wp_{f,l}, {}_wp_{f,r} \in \Rnum^3$ are the positions of the landing feet 
and $ {}_w\hat{p}_{R,i} = \frac{p -  p_{a,i}}{\Vert p - p_{a,i} \Vert } \in \Rnum^3$ the direction of the i-th rope axis with $i \in \{l,r\}$.

The friction cone constraints are imposed on the contact forces at the landing feet $f_{L,l}, f_{R,l}$ that the leg exerts 
on the wall to avoid slippage. Instead of encoding them as a second order cone constraint we 
require the contact force to be inside an inner pyramidal (conservative) approximation of the  friction  cone, 
resulting in a set of linear constraints to be embedded in our QP problem. This approximation is widely adopted in the robotics community. 

Given the  contact surface normal $\mathbf{n} \in \Rnum^3$, 
tangent vectors $\mathbf{t}_{x}, \mathbf{t}_{y} \in \Rnum^3$, 
and the friction coefficient $\mu_i \in \Rnum$,
the constraint matrix for the $i-th$  landing foot writes:

%
\begin{equation}\label{eq:force_constraint_matrix}
\begin{aligned}
\mathbf{C}_{f,i} &= \mat{
		(\mathbf{t}_{x} - \mu_i \mathbf{n})^T\\ 
		(\mathbf{t}_{y} - \mu_i \mathbf{n})^T \\ 
		-(\mathbf{t}_{x} + \mu_i \mathbf{n})^T \\ 
		- (\mathbf{t}_{y} + \mu_i \mathbf{n})^T} \in \Rnum^{4 \times 3} 
\quad
\mathbf{d}_{f,i} =\mat{ 0 \\0\\0\\0}
\end{aligned}
\end{equation}


Where we assumed both landing feet share the same normal to the surface they are in contact with. 
Note that the cone constraints implicitly encode also the unilaterality constraints that claims that bound the contact forces
to  exist only in the half-space external to the wall (i.e. the legs can only push and not pull). 
However, we still need append to $C_f$, $d_f$ additional unilateral  constraints relative to the rope 
forces. They encode the fact that ropes have always to be pulling (e.g. $F_{R,l}<0$,$F_{R,r}<0$) to avoid getting untight.

\begin{equation}\label{eq:force_constraint_matrix}
\begin{aligned}
\mathbf{C} &= \mat{ C_{f,l}         &  0_{4 \times 3} & 0_{4 \times 1} & 0_{4 \times 1} \\
					0_{4 \times 3}  &  C_{f,r}   	  & 0_{4 \times 1} &  0_{4 \times 1}\\	
					0_{1 \times 3} 	&  0_{1 \times 3}  & 1      	   &      0  \\
					0_{1 \times 3} 	&  0_{1 \times 3}  & 0             &      1   }	
\end{aligned}
\quad
\mathbf{d} =\mat{ d_{f,l}\\d_{f,r} \\0\\0}
\end{equation}




% how to compute it in practice
To perform the static analysis we have to  define the parameters  
 base-line (distance between landing feet) $d_b = 0.8$ and  wall clearance $d_w = 0.4$ (defined in Fig. \ref{fig:3dmodel2anchors}(right)).
Then we solve the QP problem for different poitions on the wall trying to see if a feasible combination of forces exists that satisfy static stability. For each solution we evaluate 
also the margin $C x^\star - d$ with respect to the situation in which the static stability is lost. This will represent how 
much external force (e.g. coming from a driller) can be tolerated for maintenance 
operation (without losing static stability), for each position of the robot  on the wall (TODO plot?).
We performed the analysis for different values of the base-line and wall clearance parameters and different values of wall rope extensions. 

	\begin{figure}
		\includegraphics[width=\columnwidth]{figs/static_analysis.png}
		\caption{Spherical pendulum}
		\label{fig:static_analysis}
	\end{figure}


The outcome of this analysis (highlighted in the accompanying video) is that the set of feasible positions 
that are statically feasible out of the convex half-space $\mathcal{A}$ (red shaded area) between the two anchors is very limited (see Fig. \ref{fig:static_analysis}).
The reason must be found in the gravity force that has a component (not compensated by the rope tension) that creates a moment that, should  be balanced by the contact forces at the landing feet. These forces, though, are limited by 1) the friction constraints that bounds their tangential component 
2) by the unilateral constraints.
The study showed that out of the $\mathcal{A}$ region the moment due to gravity is 
causing the complete unloading of the most external foot, at a distance $d_b$ from the  vertical to the closest anchor, with the risk of tipping over,  
making the robot unsuitable to perform maintenance operations.
When the robot is more detached from the wall 




\section{Motion Planning}
The motion plan for the robot is decided by solving an optimal control problem \emph{\`a la} Pontryagin.
Generally speaking, we can set up the problem in the following way: \vspace{-0.5cm}


\begin{equation}\label{eq:OCP}
\begin{aligned}
& J = \min_{\vect{u}(t)} \,M(\vect{x}(t_0),\vect{x}(t_f),t_0,t_f)+\int_{t_0}^{t_f}   L\left(\vect{x}(t),\vect{u}(t)\right) dt\\
&\text{subject to:}\\
&\,\,\dot{\vect{x}}(t) = \vect{f}(\vect{x}(t),\vect{u}(t)),\\
&\,\,\vect{u} \in \mathcal{U},\\
&\,\,\vect{h}\left(\vect{x}(t),\vect{u}(t)\right) \leq 0,\\
&\,\,\vect{B}(\vect{x}(t_0), t_0, \vect{x}(t_f), t_f)=0,
\end{aligned}
\end{equation}

where $\vect{x}$ is the vector of state variables, $\vect{u}$ is the control input constrained in the convex set $\mathcal{U}$, $f$ is the dynamic equation of the system,
$\vect{h}$ is the constraint on the state and control variables, $\vect{B}$ are the boundary conditions, $t_0$ and $t_f$ are the initial and final time (that is an optimization variable), which can be part of the optimization. The OCP~\eqref{eq:OCP} is in the standard form with Mayer term $M$ and Lagrange term $L$ that model initial/terminal costs and  the running cost, respectively.\\
\noindent
{\bf Dynamical System.}
The state $\vect{x}$ of our problem is $\vect{x} = \left[\theta,\,\phi,\,l,\,\dot{\theta},\,\dot{\phi},\, \dot{l}\right]^T$, while the control variables are
given by $\vect{u} = \left[\vect{F}_u,\,\vect{F}_t\right]^T$. The dynamic equation is derived from~\eqref{eq:nonlinearDyn}:
\begin{equation}
\label{eq:NonLinStateSpace}
\begin{aligned}
\begin{bmatrix}
\dot{x}_1\\\dot{x}_2 \\ \dot{x}_3\\ \dot{x}_4\\ \dot{x}_5\\ \dot{x}_6\end{bmatrix}
=
\begin{bmatrix}
x_4\\
x_5\\ x_6 \\  - \frac{2}{x_3} x_4 x_6 + c_{x_1} s_{x_1}  x_5^2 - \frac{g}{x_3}  s_{x_1} +  \frac{1}{mx_3}F_{u,n}\\
- 2 \frac{c_{x_1}}{s_{x_1}} x_4 x_5 - \frac{2}{x_3} x_5 x_6 + \frac{1}{mx_3 s_{x_1}} F_{u,t}\\
x_3 x_4^2 + x_3 s^2_{x_1}x_5^2+g c_{x_1} +\frac{1}{m}F_r .
\end{bmatrix}
\end{aligned}
\end{equation}

\noindent
{\bf Boundary Conditions.}
The terminal constraints are usually expressed in Cartesian space $[X,\,Y,\,Z,\,\dot{X},\dot{Y},\dot{Z}]^T$ and they can be expressed as a function of
the state variables by means of~\eqref{eq1}. For instance, for $X,Y,Z$, we have:
\begin{equation}
\begin{aligned}
&x_1= \atandue\left(-Z,\sqrt{X^2+Y^2}\right), \\ 
&x_2 = \atandue(Y,X),\\
&x_3 = \sqrt{X^2+Y^2+Z^2},\quad \\
%  &x_4(t_0) = \frac{1}{\Lambda}\left(c_{x_{1}(t_0)} c_{x_2(t_0)} \dot{X}_0 +c_{x_1(t_0)}s_{x_2(t_0)} \dot{Y}_0+s_{x_1(t_0)}\dot{Z}_0\right)\\
%   &x_5(t_0) = \frac{1}{\Lambda s_{x_1(t_0)}}\left(-s_{x_2(t_0)} \dot{X}_0) \right) + \\
%   &\quad  +  \frac{1}{\Lambda s_{x_1(t_0)}} \left(c_{x_2(t_0)} - c_{x_2(t_0)} c^2_{x_1(t_0)} + c^2_{x_1(t_0)} s_{x_2(t_0)}  \right) \dot{Y}_0 \\
%    &\quad + \frac{1}{2 \Lambda}\left(-c_{x_1(t_0)}\left(\sqrt{2}\sin\left(2 x_2(t_0)+\pi/4\right)-1 \right) \right) \dot{Z}_0 \\
%    &x_6(t_0) = \frac{x_3(0)}{\Lambda}\left(s_{x_{1}(t_0)} c_{x_2(t_0)} \dot{X}_0 + s_{x_1(t_0)}s_{x_2(t_0)} \dot{Y}_0\right)\\
%    & \quad + \frac{1}{2 \Lambda} c_{x_1(t_0)}\left(\sqrt{2} \cos\left(2 x_2(t_0)+\pi/4\right)-\frac{1}{2}\right) \dot{Z}_0 \\
%   &\Lambda = x_3(t_0) \left(c_{x_2(t_0)} s_{x_2(t_0)} c^2_{x_1(t_0)} - c^2_{x_2(t_0)} c^2_{x_1(t_0)} + 1\right).
\end{aligned}
\end{equation}

\noindent
{\bf State Constraints.}
State constraints are related to regions of the operation space that are not accessible. For instance, an irregular form of the walls
could generate obstacles that the robot 
has to overcome in order to reach its final destination. Generally speaking, the inaccessible area is modelled as
a region whose boundary is a surface. We assume that this surface can be expressed by
a differential 2D manifold expressed by $f(\vect{x}) = 0$. Therefore the admissible region is generally given by
$f(\vect{x}) \geq 0$ and could be non-convex. 
%By using~\eqref{eq1}, we can express the constraint either in Cartesian coordinates or in terms of the state variables. 
Another constraint is added to prevent collision with the wall (i.e. $X >0$) and to ensure the robot elevation does not exceed the anchor level (i.e. $Z<0$).


\noindent
{\bf Actuation Constraints.}
The system actuators are given by the two forces $\mathbf{F}_r$ and $\mathbf{F}_u$.
The $\mathbf{F}_r$ force acts along the direction of the rope ($\vect{e}_R$ axis). % \vect{f}_r$ (see~\eqref{eq:forces}) this is for journal
Since the rope cannot push the robot 
(assumption 3, the rewinder can only pull the wire), $F_r$ can only be used to retract the robot or to slow down its descent (under the action of gravity). 
Moreover, the force is bounded by the limits of the actuators (e.g. a hoist). Therefore, the
constraint on $F_r$ is:
\[
-F_r^{\text{max}} \leq F_r \leq 0.
\]
As regards $\mathbf{F}_u$, since it is meant to act for a very short duration, reaching high peaks, we model it through a Dirac impulse: $\mathbf{F}_u   (t) = \mathbf{F}_u \delta(t)$, where
$\mathbf{F}_u$ is a vector with the two components $F_{u,t}$ and $F_{u,n}$.
The Dirac delta is a generalized function and cannot be handled by the optimal control frameworks, therefore, a smooth approximation is needed.
A natural approximation is a Gaussian function, that is $\delta(t-t_0) \approx \frac{1}{\sqrt{2 \pi \sigma^2}} e^{-\frac{(t-t_0)^2}{2 \sigma^2}}$, \cite{saichev:1996}. The duration $T_{th}$ of the impulse 
is roughly given by $6 \sigma$. Given the nature of our actuation mechanism, a realistic choice is to have a duration in the order of tens of milliseconds, which consequently
determines a remarkable intensity of the impulse. The maximum norm of $\mathbf{F}_u$ is upper-bounded by the actuation limits:
\[
\sqrt{F_{u,n}^2 + F_{u,t}^2} \leq F_{u}^{\text{max}} \quad .
\]
Additionally, the tangential component $F_{u,t}$ is generated by the friction with the mountain wall. 
Hence, $F_{u,n}$ and $F_{u,t}$ are constrained by the following relation (friction cone):
\begin{align*}
\vert F_{u,t} \vert \leq \mu F_{u,n}
\end{align*} 
where $\mu$ is the \textit{friction coefficient}, a constant depending on the nature of the terrain. 
%For our simulation scenarios below, we have chosen $\mu = 0.8$ and $F_u^{\text{max}}=1000$ N. 

\noindent
{\bf Objective Function.}
%The cost functional is composed of two terms: an integral component accounting for the cost accumulated during a period of time, and a terminal component, which accounts for the cost related to the final configuration of the system.
The cost is composed of three terms. 
First, we minimize the time $t_f$ to complete the mission (assuming without loss of generality that $t_0=0$). 
Second, we minimize the final kinetic energy $K(t_f)$ because when the robot lands, it has to dissipate the energy through a damper (we are not considering to reuse the accumulated energy to re-bounce after landing).
Third, we minimize the work performed by the winding mechanism.
Thus, the cost is:
\begin{align*}
&J = w_tt_f + w_E K(t_f) + w_{F_r} \int_{0}^{t_f} (F_r\cdot x_6(t))^2 dt ,  \\
& K(t) = \frac{m}{2} x_3(t)^2 \left(x_4(t)^2 + s_{x_1(t)}^2+ x_5(t)^2 \right) + \frac{m }{2} x_6(t)^2,
\end{align*}
%%%
with $w_t$, $w_E$ and $w_{F_r}$ being the weights associated to the three cost components.
%We are interested in minimizing the interval of time $t_f - t_0$ needed to complete the mission and the kinetic energy $K(t_f)$ at the final instant. The reason for $K(t_f)$ is because when the robot lands,
%it has to stop its motion and dissipate the energy through a damper (at the moment we are not considering to reuse the accumulated energy to re-bounce after landing).
%Therefore, assuming without loss of generality that $t_0=0$, we optimize
%\begin{align*}
%&J = w_tt_f + w_E K(t_f) + w_{F_r} \int_{0}^{t_f} (F_r\cdot x_6(t))^2 dt ,  \\
%& K(t) = \frac{m}{2} x_3(t)^2 \left(x_4(t)^2 + s_{x_1(t)}^2+ x_5(t)^2 \right) + \frac{m }{2} x_6(t)^2,
%\end{align*}
%%%%
%with $w_t$ and $w_E$ two weights to combine the temporal with the energetic contribution while $w_{F_r}$ is the weight 
%associated to a term proportional to the work performed by the winding mechanism.
We should observe that, in case of a difficult convergence, it is possible to ``soften'' some of the constraints. For instance, for the terminal constraint, it is possible to introduce a
slack variable $\Delta$ and have a constraint $\left\|\vect{p}(t_f) - \vect{p}_f\right\|^2 \leq \Delta$, where the slack $\Delta$ can be either a maximum tolerance set by the user or become part of the cost function. Another possibility is to add the relaxed constraint as a penalty in the objective function.

\noindent
\textbf{Initial guess.}
To speed-up convergence, we initialized the optimization with a reasonable initial guess.
Because time $t_f$ is an optimization parameter, we compute the time constant for the system linearized around the initial state. %The other variables were initialised ...
The linearized system becomes also a good approximation when the jump length is small with respect to the rope elongation. 



%\input{include/ContLyap}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% that's all folks

\bibliographystyle{IEEEtran}

\bibliography{include/biblio}


\end{document}